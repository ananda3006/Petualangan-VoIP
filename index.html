<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan VoIP</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .game-container {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .header {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .game-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00f5ff, #ff00ff, #ffff00);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
            margin-bottom: 0.5rem;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #00f5ff;
            margin-bottom: 1rem;
        }
        
        .main-content {
            flex: 1;
            position: relative;
            z-index: 10;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .screen {
            display: none;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .player-setup {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 3rem;
            border: 2px solid rgba(0, 245, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #00f5ff;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .avatar-option {
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .avatar-option:hover, .avatar-option.selected {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.2);
            transform: scale(1.05);
        }
        
        .btn {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 245, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0px);
        }
        
        .ai-companion {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(0, 245, 255, 0.3), rgba(255, 0, 255, 0.3));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
            z-index: 100;
            border: 3px solid rgba(0, 245, 255, 0.5);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .ai-speech {
            position: fixed;
            bottom: 160px;
            right: 2rem;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 1.5rem;
            max-width: 300px;
            border: 2px solid rgba(0, 245, 255, 0.3);
            display: none;
            z-index: 101;
        }
        
        .ai-speech.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes alertPulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 0, 0, 0.8);
                transform: scale(1.02);
            }
        }
        
        @keyframes textGlitch {
            0%, 90%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        @keyframes buttonPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            }
        }
        
        @keyframes dangerBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .mission-warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        .mission-warning-modal {
            background: linear-gradient(135deg, #1a0000, #330000);
            border: 3px solid #ff0000;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            animation: alertPulse 2s infinite;
        }
        
        .warning-header {
            margin-bottom: 1.5rem;
        }
        
        .warning-content {
            margin-bottom: 1.5rem;
        }
        
        .danger-btn {
            position: relative;
            overflow: hidden;
        }
        
        .danger-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: dangerSweep 2s infinite;
        }
        
        @keyframes dangerSweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .level-map {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            padding: 3rem;
            margin: 2rem 0;
            border: 2px solid rgba(0, 245, 255, 0.3);
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .level-map::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 25%, rgba(0, 245, 255, 0.1) 0%, transparent 30%),
                radial-gradient(circle at 85% 75%, rgba(255, 0, 255, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%, rgba(0, 245, 255, 0.05) 0%, transparent 60%);
            pointer-events: none;
        }
        
        .map-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .treasure-path {
            fill: none;
            stroke: rgba(0, 245, 255, 0.6);
            stroke-width: 4;
            stroke-dasharray: 8, 4;
            stroke-linecap: round;
            opacity: 0.7;
            filter: drop-shadow(0 0 8px rgba(0, 245, 255, 0.3));
        }
        
        .treasure-path.completed {
            stroke: #00f5ff;
            stroke-width: 5;
            opacity: 1;
            filter: drop-shadow(0 0 12px rgba(0, 245, 255, 0.8));
        }
        
        .level-nodes {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 400px;
        }
        
        .level-node {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 5px solid;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.6));
            backdrop-filter: blur(10px);
            box-shadow: 
                0 8px 16px rgba(0, 0, 0, 0.4),
                inset 0 2px 8px rgba(255, 255, 255, 0.1);
        }
        
        .level-node:nth-child(1) {
            top: 60%;
            left: 8%;
            transform: rotate(-5deg);
        }
        
        .level-node:nth-child(2) {
            top: 25%;
            left: 25%;
            transform: rotate(8deg);
        }
        
        .level-node:nth-child(3) {
            top: 15%;
            right: 30%;
            transform: rotate(-3deg);
        }
        
        .level-node:nth-child(4) {
            top: 45%;
            right: 15%;
            transform: rotate(6deg);
        }
        
        .level-node:nth-child(5) {
            top: 70%;
            right: 8%;
            transform: rotate(-8deg);
        }
        
        .level-node.available {
            border-color: #00f5ff;
            color: #00f5ff;
            background: radial-gradient(circle, rgba(0, 245, 255, 0.3), rgba(255, 255, 255, 0.1));
            box-shadow: 
                0 0 25px rgba(0, 245, 255, 0.6),
                0 8px 16px rgba(0, 0, 0, 0.4),
                inset 0 2px 8px rgba(0, 245, 255, 0.2);
            animation: treasurePulse 2s infinite;
        }
        
        .level-node.completed {
            border-color: #ff00ff;
            color: #ffffff;
            background: radial-gradient(circle, rgba(255, 0, 255, 0.6), rgba(0, 245, 255, 0.4));
            box-shadow: 
                0 0 35px rgba(255, 0, 255, 0.8),
                0 0 60px rgba(255, 0, 255, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.4),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
            animation: treasureGlow 3s infinite;
        }
        
        .level-node.locked {
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.5);
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.8));
            cursor: not-allowed;
            opacity: 0.4;
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.6),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .level-node:hover:not(.locked) {
            transform: scale(1.15) rotate(calc(var(--rotation, 0deg) + 5deg));
            z-index: 10;
            filter: brightness(1.2) drop-shadow(0 0 20px rgba(0, 245, 255, 0.6));
        }
        
        .level-node:active:not(.locked) {
            transform: scale(1.05) rotate(var(--rotation, 0deg));
        }
        
        .level-node::after {
            content: attr(data-level);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem;
            font-weight: bold;
            color: #00f5ff;
            text-shadow: 
                0 0 8px rgba(0, 245, 255, 0.8),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(255, 255, 255, 0.1);
            padding: 0.3rem 0.6rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 245, 255, 0.4);
            backdrop-filter: blur(5px);
        }
        
        .level-node.completed::after {
            color: #ff00ff;
            text-shadow: 
                0 0 12px rgba(255, 0, 255, 1),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(255, 0, 255, 0.2);
            border-color: #ff00ff;
        }
        
        .level-node.locked::after {
            color: rgba(255, 255, 255, 0.5);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        @keyframes treasurePulse {
            0%, 100% { 
                box-shadow: 
                    0 0 25px rgba(0, 245, 255, 0.6),
                    0 8px 16px rgba(0, 0, 0, 0.4),
                    inset 0 2px 8px rgba(0, 245, 255, 0.2);
                transform: scale(1) rotate(var(--rotation, 0deg));
            }
            50% { 
                box-shadow: 
                    0 0 40px rgba(0, 245, 255, 0.9),
                    0 0 60px rgba(0, 245, 255, 0.3),
                    0 8px 16px rgba(0, 0, 0, 0.4),
                    inset 0 2px 8px rgba(0, 245, 255, 0.4);
                transform: scale(1.08) rotate(var(--rotation, 0deg));
            }
        }
        
        @keyframes treasureGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 35px rgba(255, 0, 255, 0.8),
                    0 0 60px rgba(255, 0, 255, 0.4),
                    0 8px 16px rgba(0, 0, 0, 0.4),
                    inset 0 2px 8px rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 
                    0 0 50px rgba(255, 0, 255, 1),
                    0 0 80px rgba(255, 0, 255, 0.6),
                    0 0 120px rgba(255, 0, 255, 0.2),
                    0 8px 16px rgba(0, 0, 0, 0.4),
                    inset 0 2px 8px rgba(255, 255, 255, 0.5);
            }
        }
        
        .inventory-panel {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 2px solid rgba(0, 245, 255, 0.3);
            z-index: 100;
            min-width: 250px;
        }
        
        .inventory-title {
            color: #00f5ff;
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .inventory-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 245, 255, 0.2);
        }
        
        .inventory-item.new-item {
            animation: newItemGlow 2s ease-in-out;
            border-color: #00f5ff;
        }
        
        @keyframes newItemGlow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(0, 245, 255, 0.8);
            }
        }
        
        .item-icon {
            font-size: 1.5rem;
            margin-right: 0.8rem;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: #ffffff;
            font-size: 0.9rem;
        }
        
        .item-description {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.2rem;
        }
        
        .current-location {
            background: rgba(0, 245, 255, 0.2);
            border: 2px solid #00f5ff;
            animation: locationPulse 2s infinite;
        }
        
        @keyframes locationPulse {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
            }
            50% { 
                box-shadow: 0 0 25px rgba(0, 245, 255, 0.8);
            }
        }
        
        .reward-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a3e, #2d1b69);
            border: 3px solid #00f5ff;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 0 50px rgba(0, 245, 255, 0.5);
            animation: rewardAppear 0.5s ease-out;
        }
        
        @keyframes rewardAppear {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.5);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .reward-title {
            color: #00f5ff;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.8);
        }
        
        .reward-item {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 245, 255, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(0, 245, 255, 0.3);
        }
        
        .reward-icon {
            font-size: 3rem;
            margin-right: 1rem;
        }
        
        .reward-info {
            text-align: left;
        }
        
        .reward-name {
            color: #00f5ff;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .reward-desc {
            color: #ffffff;
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }

        .game-screen {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 3rem;
            border: 2px solid rgba(0, 245, 255, 0.3);
        }
        
        .question-container {
            margin: 2rem 0;
        }
        
        .question {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: #00f5ff;
        }
        
        .options {
            display: grid;
            gap: 1rem;
        }
        
        .option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: #00f5ff;
        }
        
        .option.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }
        
        .option.incorrect {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
        }
        
        .score-display {
            position: fixed;
            top: 2rem;
            left: 2rem;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            border: 2px solid rgba(0, 245, 255, 0.3);
            z-index: 100;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f5ff, #ff00ff);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .cutscene {
            text-align: center;
            padding: 3rem;
        }
        
        .cutscene-text {
            font-size: 1.5rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            animation: typewriter 3s steps(50) 1s both;
        }
        
        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .certificate {
            background: linear-gradient(135deg, #1a1a3e, #2d1b69);
            border: 3px solid #00f5ff;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            margin: 2rem auto;
            max-width: 600px;
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
            animation: certificateGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes certificateGlow {
            0% { 
                box-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
                transform: scale(1);
            }
            100% { 
                box-shadow: 0 0 50px rgba(255, 0, 255, 0.7);
                transform: scale(1.02);
            }
        }
        
        .certificate-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            color: #00f5ff;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .player-setup {
                padding: 2rem;
            }
            
            .ai-companion {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
            
            .ai-speech {
                max-width: 250px;
            }

            .mission-warning-modal {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="stars" id="stars"></div>
        
        <header class="header">
            <h1 class="game-title">Petualangan VoIP</h1>
            <p class="subtitle">Sang Penjaga Suara Digital</p>
        </header>
        
        <div class="score-display" id="scoreDisplay" style="display: none;">
            <div> <img src="images/icon score.png" alt="icon score" width="30px"> Skor: <span id="currentScore">0</span> </div>
            <div> <img src="images/icon level.png" alt="icon level" width="30px"> Level: <span id="currentLevel">1</span></div>
            <div style="margin-top: 0.5rem;">
                <button id="soundToggle" onclick="toggleSound()" style="background: none; border: none; color: #00f5ff; cursor: pointer; font-size: 1.2rem; margin-right: 0.5rem;">🔊</button>
                <button id="voiceToggle" onclick="toggleAIVoice()" style="background: none; border: none; color: #ff00ff; cursor: pointer; font-size: 1.2rem;" title="Toggle AI Voice">🎤</button>
            </div>
        </div>

        <div class="inventory-panel" id="inventoryPanel" style="display: none;">
            <div class="inventory-title">🎒 Inventory</div>
            <div id="inventoryItems">
                <!-- Items will be added dynamically -->
            </div>
        </div>
        
        <main class="main-content">
            <!-- Setup Screen -->
            <div class="screen active" id="setupScreen">
                <div class="player-setup">
                    <h2 style="text-align: center; margin-bottom: 2rem; color: #00f5ff;">Persiapan Petualangan</h2>
                    
                    <div class="form-group">
                        <label for="playerName">Nama Pemain:</label>
                        <input type="text" id="playerName" placeholder="Masukkan nama kamu">
                    </div>
                    
                    <div class="form-group">
                        <label for="playerClass">Kelas & Jurusan:</label>
                        <select id="playerClass">
                            <option value="">Pilih kelas dan jurusan</option>
                            <option value="XI TKJ 1">XI TKJ 1</option>
                            <option value="XI TKJ 2">XI TKJ 2</option>
                            <option value="XI RPL 1">XI RPL 1</option>
                            <option value="XI RPL 2">XI RPL 2</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Pilih Avatar:</label>
                        <div class="avatar-selection">
                            <div class="avatar-option" data-avatar= "<img src="images/avatar teknisi cewek.png" alt="avatar teknisi cewek" width="50px"> <img src="images/avatar teknisi cewek.png" alt="avatar teknisi cewek" width="50px"> </div>
                            <div class="avatar-option" data-avatar= "<img src="images/avatar teknisi cowok.png" alt="avatar teknisi cowok" width="50px"> <img src="images/avatar teknisi cowok.png" alt="avatar teknisi cowok" width="50px"> </div>
                            <div class="avatar-option" data-avatar= "<img src="images/avatar robot cewek.png" alt="avatar robot cewek" width="50px"> <img src="images/avatar robot cewek.png" alt="avatar robot cewek" width="50px"> </div>
                            <div class="avatar-option" data-avatar= "<img src="images/avatar robot cowok.png" alt="avatar robot cowok" width="50px"> <img src="images/avatar robot cowok.png" alt="avatar robot cowok" width="50px"> </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="difficulty">Tingkat Kesulitan:</label>
                        <select id="difficulty">
                            <option value="easy">Mudah</option>
                            <option value="medium">Sedang</option>
                            <option value="hard">Sulit</option>
                        </select>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="playSound('click'); startGame()">Mulai Petualangan</button>
                    </div>
                </div>
            </div>
            
            <!-- Intro Cutscene -->
            <div class="screen" id="introScreen">
                <div class="cutscene">
                    <div class="alert-container" style="background: rgba(255, 0, 0, 0.2); border: 3px solid #ff0000; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; animation: alertPulse 1s infinite;">
                        <h2 style="color: #ff0000; margin-bottom: 1rem; font-size: 2.5rem; text-shadow: 0 0 20px #ff0000; animation: textGlitch 0.5s infinite;">⚠️ SISTEM ERROR KRITIS ⚠️</h2>
                        <div style="color: #ffff00; font-size: 1.2rem; margin-bottom: 1rem; animation: blink 0.8s infinite;">KONEKSI TERPUTUS - JARINGAN GLOBAL DOWN</div>
                        <div style="color: #ff6666; font-size: 1rem;">STATUS: EMERGENCY PROTOCOL ACTIVATED</div>
                    </div>
                    <div class="cutscene-text" style="color: #ff9999;">
                        <strong style="color: #ff0000;">MAYDAY! MAYDAY!</strong> Dunia komunikasi digital sedang dalam bahaya! "Virus Hening" telah menyerang jaringan VoIP global, memutus semua koneksi suara digital. Sistem keamanan gagal total! Sebagai Guardian of Echo, kamu adalah harapan terakhir untuk memulihkan sistem komunikasi dunia sebelum terlambat!
                    </div>
                    <button class="btn" onclick="playSound('click'); showLevelMap()" style="background: linear-gradient(45deg, #ff0000, #ff6600); animation: buttonPulse 1.5s infinite;">🚀 TERIMA MISI DARURAT</button>
                </div>
            </div>
            
            <!-- Level Map -->
            <div class="screen" id="levelMapScreen">
                <h2 style="text-align: center; margin-bottom: 2rem; color: #00f5ff;">🗺️ Peta Petualangan Digital</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="gameProgress"></div>
                </div>
                
                <div class="level-map">
                    <svg class="map-path" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet">
                        <path class="treasure-path" id="treasurePath" 
                              d="M 80 240 Q 150 100 200 100 T 350 60 Q 450 60 520 180 T 720 280" 
                              stroke-dasharray="12,6" />
                        <!-- Decorative elements -->
                        <circle cx="80" cy="240" r="3" fill="#00f5ff" opacity="0.6"/>
                        <circle cx="200" cy="100" r="2" fill="#00f5ff" opacity="0.4"/>
                        <circle cx="350" cy="60" r="2" fill="#00f5ff" opacity="0.4"/>
                        <circle cx="520" cy="180" r="2" fill="#00f5ff" opacity="0.4"/>
                        <circle cx="720" cy="280" r="3" fill="#ff00ff" opacity="0.8"/>
                        
                        <!-- Compass Rose -->
                        <g transform="translate(50, 50)" opacity="0.3">
                            <circle cx="0" cy="0" r="25" fill="none" stroke="#00f5ff" stroke-width="2"/>
                            <path d="M 0,-20 L 5,0 L 0,20 L -5,0 Z" fill="#00f5ff"/>
                            <text x="0" y="-30" text-anchor="middle" fill="#00f5ff" font-size="12" font-weight="bold">N</text>
                        </g>
                        
                        <!-- Digital portal at the end -->
                        <g transform="translate(720, 280)" opacity="0.6">
                            <circle cx="0" cy="0" r="8" fill="none" stroke="#ff00ff" stroke-width="2"/>
                            <circle cx="0" cy="0" r="4" fill="#00f5ff" opacity="0.8"/>
                            <circle cx="0" cy="0" r="2" fill="#ffffff"/>
                        </g>
                    </svg>
                    
                    <div class="level-nodes">
                        <div class="level-node available" data-level="Level 1" onclick="showMissionWarning(1)" onmouseover="playSound('hover')" style="--rotation: -5deg;">
                             <img src="images/icon level 1.png" alt="icon level 1" width="70px">
                        </div>
                        
                        <div class="level-node locked" data-level="Level 2" id="level2" style="--rotation: 8deg;">
                            <img src="images/icon level 2.png" alt="icon level 2" width="70px">
                        </div>
                        
                        <div class="level-node locked" data-level="Level 3" id="level3" style="--rotation: -3deg;">
                            <img src="images/icon level 3.png" alt="icon level 3" width="70px">
                        </div>
                        
                        <div class="level-node locked" data-level="Level 4" id="level4" style="--rotation: 6deg;">
                            <img src="images/icon level 4.png" alt="icon level 4" width="70px">
                        </div>
                        
                        <div class="level-node locked" data-level="Level 5" id="level5" style="--rotation: -8deg;">
                            <img src="images/icon level 5.png" alt="icon level 5" width="70px">
                        </div>
                    </div>
                </div>

                    <div style="text-align: center; margin-top: 2rem; color: rgba(255, 255, 255, 0.8);">
                    <p>🟡 = Level Tersedia | 🟠 = Level Terkunci | ✨ = Level Selesai</p>
                </div>
            </div>
            
            <!-- Game Screen -->
            <div class="screen" id="gameScreen">
                <div class="game-screen">
                    <h2 id="levelTitle" style="text-align: center; color: #00f5ff; margin-bottom: 2rem;"></h2>
                    
                    <div id="materialSection" style="margin-bottom: 2rem;">
                        <h3 style="color: #ff00ff; margin-bottom: 1rem;">📚 Materi Pembelajaran</h3>
                        <div id="materialContent" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;"></div>
                    </div>
                    
                    <div class="question-container">
                        <h3 style="color: #ff00ff; margin-bottom: 1rem;">❓ Tantangan</h3>
                        <div class="question" id="questionText"></div>
                        <div class="options" id="optionsContainer"></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" id="nextButton" onclick="playSound('click'); nextQuestion()" style="display: none;">Lanjut</button>
                        <button class="btn" onclick="playSound('click'); showLevelMap()" style="margin-left: 1rem;">Kembali ke Peta</button>
                    </div>
                </div>
            </div>
            
            <!-- Final Screen -->
            <div class="screen" id="finalScreen">
                <div class="cutscene">
                    <h2 style="color: #00ff00; margin-bottom: 2rem;">🎉 MISI BERHASIL! 🎉</h2>
                    <div class="cutscene-text">
                        Selamat! Kamu telah berhasil mengalahkan Virus Hening dan memulihkan jaringan VoIP global. Komunikasi digital kembali normal berkat keahlianmu!
                    </div>
                    
                    <div class="certificate">
                        <div class="certificate-title">🏆 SERTIFIKAT DIGITAL 🏆</div>
                        <h3>Guardian of Echo</h3>
                        <p style="margin: 1rem 0;">Diberikan kepada:</p>
                        <h2 id="certificateName" style="color: #00f5ff;"></h2>
                        <p style="margin: 1rem 0;">Sebagai Penjaga Komunikasi Digital Masa Depan</p>
                        <p>Skor Akhir: <span id="finalScore"></span></p>
                    </div>
                    
                    <button class="btn" onclick="playSound('click'); restartGame()">Main Lagi</button>
                </div>
            </div>
        </main>

        <!-- Mission Warning Modal -->
        <div class="mission-warning-overlay" id="missionWarning" style="display: none;">
            <div class="mission-warning-modal">
                <div class="warning-header">
                    <h2 style="color: #ff0000; font-size: 2rem; text-shadow: 0 0 20px #ff0000; animation: dangerBlink 0.5s infinite;">⚠️ PERINGATAN BAHAYA ⚠️</h2>
                </div>
                <div class="warning-content">
                    <div class="danger-text" style="color: #ffff00; font-size: 1.3rem; margin: 1rem 0; animation: dangerBlink 0.8s infinite;">
                        🚨 ZONA BERBAHAYA TERDETEKSI! 🚨
                    </div>
                    <p style="color: #ff9999; font-size: 1.1rem; margin: 1rem 0;">
                        Kamu akan memasuki area yang dikuasai oleh <strong style="color: #ff0000;">Virus Hening</strong>! 
                        Sistem keamanan mendeteksi ancaman tingkat tinggi di lokasi ini.
                    </p>
                    <div id="missionDetails" style="background: rgba(255, 0, 0, 0.2); padding: 1rem; border-radius: 10px; margin: 1rem 0; border: 2px solid #ff0000;">
                        <div style="color: #ffff00; font-weight: bold;">DETAIL MISI:</div>
                        <div id="missionDescription" style="color: #ffffff; margin-top: 0.5rem;"></div>
                    </div>
                    <div style="color: #ff6666; font-size: 0.9rem; animation: dangerBlink 1s infinite;">
                        ⚡ Pastikan kamu siap menghadapi tantangan ini! ⚡
                    </div>
                </div>
                <div class="warning-buttons" style="margin-top: 2rem; text-align: center;">
                    <button class="btn danger-btn" onclick="acceptMission()" style="background: linear-gradient(45deg, #ff0000, #ff6600); margin-right: 1rem; animation: buttonPulse 1.5s infinite;">
                        🚀 TERIMA MISI BERBAHAYA
                    </button>
                    <button class="btn" onclick="cancelMission()" style="background: linear-gradient(45deg, #666666, #999999);">
                        ❌ BATALKAN
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Reward Notification -->
        <div class="reward-notification" id="rewardNotification" style="display: none;">
            <div class="reward-title">🎉 ITEM BARU DIPEROLEH! 🎉</div>
            <div class="reward-item" id="rewardItem">
                <div class="reward-icon" id="rewardIcon">🔧</div>
                <div class="reward-info">
                    <div class="reward-name" id="rewardName">Item Name</div>
                    <div class="reward-desc" id="rewardDesc">Item Description</div>
                </div>
            </div>
            <button class="btn" onclick="closeRewardNotification()" style="margin-top: 1rem;">
                ✨ TERIMA ITEM
            </button>
        </div>
        
        <!-- AI Companion -->
        <div class="ai-companion" id="aiCompanion" onclick="toggleAISpeech()">
            <img src="images/ai karakter.png" alt="karakter ai" width="200px">
        </div>
        
        <div class="ai-speech" id="aiSpeech">
            <div id="aiMessage">Halo! Aku Ananda, AI pendampingmu. Klik aku kapan saja untuk mendapat bantuan!</div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            playerName: '',
            playerClass: '',
            playerAvatar: '',
            difficulty: 'medium',
            currentLevel: 1,
            score: 0,
            completedLevels: [],
            currentQuestionIndex: 0,
            
        };

        // Item Database
        const gameItems = {
            'voip-analyzer': {
                name: 'VoIP Analyzer',
                icon: '📡',
                description: 'Menunjukkan lokasi saat ini di peta'
            },
            'sound-decoder': {
                name: 'Sound Decoder',
                icon: '🔊',
                description: 'Memecahkan kode suara digital'
            },
            'network-scanner': {
                name: 'Network Scanner',
                icon: '🌐',
                description: 'Memindai jaringan VoIP'
            },
            'protocol-key': {
                name: 'Protocol Key',
                icon: '🔑',
                description: 'Membuka protokol komunikasi'
            },
            'security-shield': {
                name: 'Security Shield',
                icon: '🛡️',
                description: 'Melindungi dari serangan cyber'
            },
            'master-codec': {
                name: 'Master Codec',
                icon: '💎',
                description: 'Codec utama untuk semua aplikasi VoIP'
            }
        };

        // Game Data
        const levels = {
            1: {
                title: "Level 1: Pulau Suara",
                material: "VoIP (Voice over Internet Protocol) adalah teknologi yang memungkinkan komunikasi suara melalui jaringan internet. Teknologi ini pertama kali dikembangkan pada tahun 1995 dan telah merevolusi cara kita berkomunikasi, mengubah panggilan telepon tradisional menjadi data digital yang dapat dikirim melalui internet.",
                questions: [
                    {
                        question: "Apa kepanjangan dari VoIP?",
                        options: ["Voice over Internet Protocol", "Video over Internet Protocol", "Virtual over Internet Protocol", "Voice on Internet Platform"],
                        correct: 0
                    },
                    {
                        question: "Kapan teknologi VoIP pertama kali dikembangkan?",
                        options: ["1990", "1995", "2000", "2005"],
                        correct: 1
                    },
                    {
                        question: "Apa keuntungan utama VoIP dibanding telepon tradisional?",
                        options: ["Lebih mahal", "Kualitas suara lebih buruk", "Biaya lebih murah", "Tidak bisa digunakan"],
                        correct: 2
                    }
                ]
            },
            2: {
                title: "Level 2: Kota Kabel",
                material: "Perangkat VoIP terdiri dari hardware dan software. Hardware meliputi IP Phone (telepon khusus VoIP), Gateway (penghubung jaringan), dan Server VoIP. Software meliputi Softphone (aplikasi telepon di komputer/HP), codec untuk kompresi suara, dan sistem manajemen panggilan.",
                questions: [
                    {
                        question: "Apa fungsi utama Gateway dalam sistem VoIP?",
                        options: ["Menyimpan data", "Menghubungkan jaringan yang berbeda", "Mengompres suara", "Mengatur panggilan"],
                        correct: 1
                    },
                    {
                        question: "Softphone adalah...",
                        options: ["Telepon fisik", "Aplikasi telepon di komputer", "Perangkat keras", "Kabel jaringan"],
                        correct: 1
                    },
                    {
                        question: "Codec dalam VoIP berfungsi untuk...",
                        options: ["Mengatur panggilan", "Mengompres dan dekompresi suara", "Menyimpan kontak", "Mengatur jaringan"],
                        correct: 1
                    }
                ]
            },
            3: {
                title: "Level 3: Menara Protokol",
                material: "Protokol VoIP utama adalah SIP (Session Initiation Protocol) untuk mengatur panggilan, RTP (Real-time Transport Protocol) untuk mengirim data suara, dan H.323 sebagai standar komunikasi multimedia. SIP paling populer karena fleksibel dan mudah diintegrasikan.",
                questions: [
                    {
                        question: "Protokol apa yang digunakan untuk mengatur panggilan VoIP?",
                        options: ["RTP", "SIP", "HTTP", "FTP"],
                        correct: 1
                    },
                    {
                        question: "RTP berfungsi untuk...",
                        options: ["Mengatur panggilan", "Mengirim data suara real-time", "Keamanan", "Kompresi"],
                        correct: 1
                    },
                    {
                        question: "Mengapa SIP lebih populer dari H.323?",
                        options: ["Lebih rumit", "Lebih fleksibel dan mudah diintegrasikan", "Lebih lambat", "Lebih mahal"],
                        correct: 1
                    }
                ]
            },
            4: {
                title: "Level 4: Benteng Keamanan",
                material: "Ancaman VoIP meliputi spam call, DoS attack yang membuat server down, dan penyadapan panggilan. Perlindungan dilakukan dengan enkripsi data suara, firewall untuk memblokir akses tidak sah, VPN untuk koneksi aman, dan sistem autentikasi yang kuat.",
                questions: [
                    {
                        question: "Apa itu DoS attack pada VoIP?",
                        options: ["Panggilan spam", "Serangan yang membuat server tidak dapat diakses", "Penyadapan", "Virus"],
                        correct: 1
                    },
                    {
                        question: "Cara melindungi VoIP dari penyadapan adalah...",
                        options: ["Menggunakan enkripsi", "Mematikan firewall", "Menggunakan password lemah", "Tidak menggunakan VPN"],
                        correct: 0
                    },
                    {
                        question: "Fungsi firewall dalam sistem VoIP adalah...",
                        options: ["Mengompres suara", "Memblokir akses tidak sah", "Mengatur panggilan", "Menyimpan data"],
                        correct: 1
                    }
                ]
            },
            5: {
                title: "Level 5: Aula Aplikasi",
                material: "VoIP diterapkan di berbagai bidang: di rumah untuk panggilan murah, di bisnis untuk sistem telepon kantor, di call center untuk layanan pelanggan, dan di pendidikan untuk pembelajaran jarak jauh. Contoh aplikasi populer: Skype, WhatsApp Call, Zoom, dan Microsoft Teams.",
                questions: [
                    {
                        question: "Contoh penerapan VoIP di bidang pendidikan adalah...",
                        options: ["Call center", "Video conference pembelajaran", "Sistem keamanan", "Game online"],
                        correct: 1
                    },
                    {
                        question: "WhatsApp Call menggunakan teknologi...",
                        options: ["Telepon tradisional", "VoIP", "Radio", "Satelit"],
                        correct: 1
                    },
                    {
                        question: "Keuntungan VoIP untuk bisnis adalah...",
                        options: ["Lebih mahal", "Fitur lebih lengkap dan biaya lebih murah", "Kualitas buruk", "Sulit digunakan"],
                        correct: 1
                    }
                ]
            }
        };

        const levelDescriptions = {
            1: "Mempelajari dasar-dasar teknologi VoIP dan sejarah perkembangannya. Virus Hening telah menginfeksi server utama di Pulau Suara!",
            2: "Mengenal perangkat keras dan software VoIP. Kota Kabel sedang diserang malware yang merusak sistem komunikasi!",
            3: "Memahami protokol komunikasi VoIP seperti SIP dan RTP. Menara Protokol dikuasai oleh bot jahat yang mengacaukan sinyal!",
            4: "Mempelajari ancaman keamanan dan cara melindungi sistem VoIP. Benteng Keamanan dalam kondisi darurat karena serangan hacker!",
            5: "Menerapkan VoIP dalam berbagai bidang kehidupan. Aula Aplikasi adalah markas terakhir Virus Hening yang harus dihancurkan!"
        };

        const aiMessages = {
            welcome: "Halo! Aku Ananda, asisten AI perempuanmu. Selamat datang di Petualangan VoIP! Aku akan membantumu memahami dunia VoIP. Siap memulai petualangan?",
            level1: "Guardian, Pulau Suara mulai diselimuti keheningan. Pulihkan gema pertama komunikasi digital dengan menjawab tantangan VoIP dasar!",
            level2: "Kota Kabel kacau! Hubungkan perangkat terputus. Sambungkan kembali fungsi perangkat VoIP agar jaringan hidup kembali.",
            level3: "Menara Protokol dalam bahaya! Jawab pertanyaan cepat tentang protokol VoIP untuk mengaktifkan sinyal pertahanan.",
            level4: "Benteng Keamanan diretas Virus Hening! Pilih strategi perlindungan digital yang benar agar benteng tetap tegak.",
            level5: "Inilah ujian terakhir! Aula Aplikasi terblokir. Tentukan penerapan VoIP pada bidang yang benar untuk memulihkan dunia digital.",     
            encouragement: ["Bagus sekali!", "Kamu hebat!", "Terus semangat!", "Jawaban yang tepat!", "Luar biasa!", "Pintar sekali!", "Keren banget!"],
            hints: [
                "Ingat, VoIP sama dengan Voice over Internet Protocol",
                "Pikirkan tentang perangkat yang kamu gunakan sehari-hari",
                "SIP untuk mengatur, RTP untuk mengirim data",
                "Keamanan selalu penting dalam teknologi",
                "VoIP ada di mana-mana di sekitar kita!"
            ],
            victory: "Selamat! Kamu berhasil menyelesaikan semua level! Kamu benar-benar Guardian of Echo yang hebat! Aku Ananda bangga padamu!",
            levelComplete: "Level selesai! Kamu semakin pintar dalam memahami VoIP!"
        };

        // Initialize game
        function initGame() {
            createStars();
            initAIVoice();
            showAIMessage(aiMessages.welcome);
            // Start with gentle menu music on setup screen
            setTimeout(() => startBackgroundMusic('menu'), 1000);
        }

        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Avatar selection
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                gameState.playerAvatar = this.dataset.avatar;
            });
        });

        function startGame() {
            const name = document.getElementById('playerName').value;
            const playerClass = document.getElementById('playerClass').value;
            const difficulty = document.getElementById('difficulty').value;

            if (!name || !playerClass || !gameState.playerAvatar) {
                alert('Mohon lengkapi semua data!');
                return;
            }

            gameState.playerName = name;
            gameState.playerClass = playerClass;
            gameState.difficulty = difficulty;

            showScreen('introScreen');
            playSound('start');
            startBackgroundMusic('intro');

            // Give starting item
            addItemToInventory('voip-analyzer');

            showScreen('introScreen');
            
            // Play dramatic alarm sound for the emergency
            setTimeout(() => {
                playSound('alarm');
            }, 500);
        }

        function addItemToInventory(itemId) {
            if (!gameState.inventory.includes(itemId)) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
                
                // Show reward notification for new items (except starting item)
                if (itemId !== 'voip-analyzer' || gameState.inventory.length > 1) {
                    showRewardNotification(itemId);
                }
            }
        }

        function updateInventoryDisplay() {
            const inventoryContainer = document.getElementById('inventoryItems');
            inventoryContainer.innerHTML = '';

            gameState.inventory.forEach((itemId, index) => {
                const item = gameItems[itemId];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                
                // Highlight current location item
                if (itemId === 'voip-analyzer') {
                    itemDiv.classList.add('current-location');
                }

                itemDiv.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                    </div>
                `;

                inventoryContainer.appendChild(itemDiv);
            });
        }

        function showRewardNotification(itemId) {
            const item = gameItems[itemId];
            
            document.getElementById('rewardIcon').textContent = item.icon;
            document.getElementById('rewardName').textContent = item.name;
            document.getElementById('rewardDesc').textContent = item.description;
            
            document.getElementById('rewardNotification').style.display = 'block';
            
            playSound('levelComplete');
            showAIMessage(`Selamat! Kamu mendapat ${item.name}! ${item.description}`);
        }

        function closeRewardNotification() {
            document.getElementById('rewardNotification').style.display = 'none';
            playSound('click');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            if (screenId !== 'setupScreen') {
                document.getElementById('scoreDisplay').style.display = 'block';
                document.getElementById('inventoryPanel').style.display = 'block';
                updateScoreDisplay();
                updateInventoryDisplay();
            }
        }

        function showLevelMap() {
            showScreen('levelMapScreen');
            updateProgress();
            updateLevelAccess();
            updateMapPath();
        }

        function updateProgress() {
            const progress = (gameState.completedLevels.length / 5) * 100;
            document.getElementById('gameProgress').style.width = progress + '%';
        }

        function updateLevelAccess() {
            for (let i = 1; i <= 5; i++) {
                const levelNode = document.getElementById(`level${i}`);
                if (!levelNode && i === 1) {
                    // Level 1 is always available (handled in HTML)
                    continue;
                }
                
                if (levelNode) {
                    levelNode.classList.remove('available', 'completed', 'locked');
                    
                    if (gameState.completedLevels.includes(i)) {
                        levelNode.classList.add('completed');
                    } else if (i === 1 || gameState.completedLevels.includes(i - 1)) {
                        levelNode.classList.add('available');
                        levelNode.onclick = () => showMissionWarning(i);
                        levelNode.onmouseover = () => playSound('hover');
                    } else {
                        levelNode.classList.add('locked');
                        levelNode.onclick = null;
                        levelNode.onmouseover = null;
                    }
                }
            }
        }

        function updateMapPath() {
            const treasurePath = document.getElementById('treasurePath');
            const completedPercentage = (gameState.completedLevels.length / 5) * 100;
            
            if (treasurePath) {
                if (completedPercentage > 0) {
                    treasurePath.classList.add('completed');
                    // Animate the path completion
                    treasurePath.style.strokeDasharray = `${completedPercentage * 2}, ${200 - (completedPercentage * 2)}`;
                } else {
                    treasurePath.classList.remove('completed');
                    treasurePath.style.strokeDasharray = '12,6';
                }
            }
        }

        function showMissionWarning(levelNum) {
            if (levelNum > 1 && !gameState.completedLevels.includes(levelNum - 1)) {
                return;
            }

            gameState.selectedLevel = levelNum;
            
            // Play danger sound
            playSound('danger');
            
            // Show AI warning message
            showAIMessage(aiMessages.warning);
            
            // Update mission details
            const level = levels[levelNum];
            document.getElementById('missionDescription').textContent = levelDescriptions[levelNum];
            
            // Show warning modal
            document.getElementById('missionWarning').style.display = 'flex';
        }

        function acceptMission() {
            playSound('click');
            document.getElementById('missionWarning').style.display = 'none';
            startLevel(gameState.selectedLevel);
        }

        function cancelMission() {
            playSound('click');
            document.getElementById('missionWarning').style.display = 'none';
            showAIMessage("Tidak apa-apa, kamu bisa kembali kapan saja ketika sudah siap!");
        }

        function startLevel(levelNum) {
            gameState.currentLevel = levelNum;
            gameState.currentQuestionIndex = 0;
            
            showScreen('gameScreen');
            loadLevel(levelNum);
            playSound('levelStart');
            showAIMessage(aiMessages[`level${levelNum}`]);
        }

        function loadLevel(levelNum) {
            const level = levels[levelNum];
            document.getElementById('levelTitle').textContent = level.title;
            document.getElementById('materialContent').textContent = level.material;
            
            loadQuestion();
        }

        function loadQuestion() {
            const level = levels[gameState.currentLevel];
            const question = level.questions[gameState.currentQuestionIndex];
            
            document.getElementById('questionText').textContent = question.question;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => {
                    playSound('click');
                    selectAnswer(index);
                };
                optionDiv.onmouseover = () => playSound('hover');
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('nextButton').style.display = 'none';
        }

        function selectAnswer(selectedIndex) {
            const level = levels[gameState.currentLevel];
            const question = level.questions[gameState.currentQuestionIndex];
            const options = document.querySelectorAll('.option');
            
            options.forEach((option, index) => {
                option.onclick = null;
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selectedIndex === question.correct) {
                gameState.score += getDifficultyMultiplier() * 10;
                playSound('correct');
                showAIMessage(aiMessages.encouragement[Math.floor(Math.random() * aiMessages.encouragement.length)]);
            } else {
                playSound('incorrect');
                showAIMessage("Jangan menyerah! Coba lagi di level berikutnya!");
            }
            
            updateScoreDisplay();
            document.getElementById('nextButton').style.display = 'inline-block';
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            const level = levels[gameState.currentLevel];
            
            if (gameState.currentQuestionIndex >= level.questions.length) {
                completeLevel();
            } else {
                loadQuestion();
            }
        }

        function completeLevel() {
            if (!gameState.completedLevels.includes(gameState.currentLevel)) {
                gameState.completedLevels.push(gameState.currentLevel);
                
                // Give reward item based on completed level
                const levelRewards = {
                    1: 'sound-decoder',
                    2: 'network-scanner', 
                    3: 'protocol-key',
                    4: 'security-shield',
                    5: 'master-codec'
                };
                
                if (levelRewards[gameState.currentLevel]) {
                    setTimeout(() => {
                        addItemToInventory(levelRewards[gameState.currentLevel]);
                    }, 1000);
                }
            }
            
            if (gameState.currentLevel === 5) {
                playSound('victory');
                setTimeout(() => {
                    showFinalScreen();
                }, 2000);
            } else {
                playSound('levelComplete');
                setTimeout(() => {
                    showLevelMap();
                    showAIMessage("Level selesai! Lanjut ke level berikutnya!");
                }, 2000);
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            if (screenId !== 'setupScreen') {
                document.getElementById('scoreDisplay').style.display = 'block';
                updateScoreDisplay();
            }
        }

        function showLevelMap() {
            showScreen('levelMapScreen');
            updateProgress();
            updateLevelAccess();
            startBackgroundMusic('menu');
        }

        function updateProgress() {
            const progress = (gameState.completedLevels.length / 5) * 100;
            document.getElementById('gameProgress').style.width = progress + '%';
        }

        function updateLevelAccess() {
            for (let i = 2; i <= 5; i++) {
                const levelCard = document.getElementById(`level${i}`);
                if (gameState.completedLevels.includes(i - 1)) {
                    levelCard.classList.remove('locked');
                    levelCard.onclick = () => {
                        playSound('click');
                        startLevel(i);
                    };
                }
            }
        }

        function startLevel(levelNum) {
            if (levelNum > 1 && !gameState.completedLevels.includes(levelNum - 1)) {
                return;
            }

            gameState.currentLevel = levelNum;
            gameState.currentQuestionIndex = 0;
            
            showScreen('gameScreen');
            loadLevel(levelNum);
            showAIMessage(aiMessages[`level${levelNum}`]);
            playSound('levelStart');
            startBackgroundMusic(`level${levelNum}`);
        }

        function loadLevel(levelNum) {
            const level = levels[levelNum];
            document.getElementById('levelTitle').textContent = level.title;
            document.getElementById('materialContent').textContent = level.material;
            
            loadQuestion();
        }

        function loadQuestion() {
            const level = levels[gameState.currentLevel];
            const question = level.questions[gameState.currentQuestionIndex];
            
            document.getElementById('questionText').textContent = question.question;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => {
                    playSound('click');
                    selectAnswer(index);
                };
                optionDiv.onmouseover = () => playSound('hover');
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('nextButton').style.display = 'none';
        }

        function selectAnswer(selectedIndex) {
            const level = levels[gameState.currentLevel];
            const question = level.questions[gameState.currentQuestionIndex];
            const options = document.querySelectorAll('.option');
            
            options.forEach((option, index) => {
                option.onclick = null;
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selectedIndex === question.correct) {
                gameState.score += getDifficultyMultiplier() * 10;
                playSound('correct');
                showAIMessage(aiMessages.encouragement[Math.floor(Math.random() * aiMessages.encouragement.length)]);
            } else {
                playSound('incorrect');
                showAIMessage("Jangan menyerah! " + aiMessages.hints[gameState.currentLevel - 1]);
            }
            
            updateScoreDisplay();
            document.getElementById('nextButton').style.display = 'inline-block';
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            const level = levels[gameState.currentLevel];
            
            if (gameState.currentQuestionIndex >= level.questions.length) {
                completeLevel();
            } else {
                loadQuestion();
            }
        }

        function completeLevel() {
            if (!gameState.completedLevels.includes(gameState.currentLevel)) {
                gameState.completedLevels.push(gameState.currentLevel);
            }
            
            if (gameState.currentLevel === 5) {
                showFinalScreen();
            } else {
                showLevelMap();
                showAIMessage(aiMessages.levelComplete + ` Lanjut ke level berikutnya!`);
            }
            
            playSound('levelComplete');
        }

        function showFinalScreen() {
            showScreen('finalScreen');
            document.getElementById('certificateName').textContent = gameState.playerName;
            document.getElementById('finalScore').textContent = gameState.score;
            
            // Start victory celebration
            createBirthdayConfetti();
            playVictoryMelody();
            startBackgroundMusic('victory');
            showAIMessage(aiMessages.victory);
        }

        function getDifficultyMultiplier() {
            switch (gameState.difficulty) {
                case 'easy': return 1;
                case 'medium': return 1.5;
                case 'hard': return 2;
                default: return 1;
            }
        }

        function updateScoreDisplay() {
            document.getElementById('currentScore').textContent = gameState.score;
            document.getElementById('currentLevel').textContent = gameState.currentLevel;
        }

        function toggleAISpeech() {
            const aiSpeech = document.getElementById('aiSpeech');
            aiSpeech.classList.toggle('show');
        }

        function playDangerSound() {
            // Dramatic danger warning sound
            const dangerPattern = [
                { freq: 150, dur: 0.3, type: 'sawtooth' },
                { freq: 200, dur: 0.2, type: 'square' },
                { freq: 120, dur: 0.4, type: 'sawtooth' },
                { freq: 180, dur: 0.25, type: 'square' }
            ];
            
            dangerPattern.forEach((sound, index) => {
                setTimeout(() => {
                    createTone(sound.freq, sound.dur, sound.type);
                }, index * 200);
            });
        }

        function showAIMessage(message) {
            document.getElementById('aiMessage').textContent = message;
            const aiSpeech = document.getElementById('aiSpeech');
            aiSpeech.classList.add('show');
            
            // Speak the message with AI voice
            speakAIMessage(message);
            
            setTimeout(() => {
                aiSpeech.classList.remove('show');
            }, 4000);
        }

        // Audio System
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let backgroundMusic = null;
        
        // AI Voice System
        let aiVoice = null;
        let speechSynthesis = window.speechSynthesis;
        
        function initAIVoice() {
            // Wait for voices to load
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    setupAIVoice();
                });
            } else {
                setupAIVoice();
            }
        }
        
        function setupAIVoice() {
            const voices = speechSynthesis.getVoices();
            
            // Priority order for most natural female voices
            const preferredVoices = [
                // Indonesian voices first
                'Google Bahasa Indonesia',
                'Microsoft Gadis - Indonesian (Indonesia)',
                'Indonesian Female',
                // High quality English female voices
                'Google UK English Female',
                'Microsoft Zira - English (United States)',
                'Microsoft Hazel - English (Great Britain)',
                'Google US English Female',
                'Samantha',
                'Victoria',
                'Serena',
                'Karen',
                'Moira',
                'Tessa',
                'Veena',
                'Fiona'
            ];
            
            // Try to find the best voice in order of preference
            for (const preferredName of preferredVoices) {
                aiVoice = voices.find(voice => 
                    voice.name.includes(preferredName) || 
                    voice.name.toLowerCase().includes(preferredName.toLowerCase())
                );
                if (aiVoice) break;
            }
            
            // Fallback: find any female voice
            if (!aiVoice) {
                aiVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('female') || 
                    voice.name.toLowerCase().includes('woman') ||
                    voice.name.toLowerCase().includes('zira') ||
                    voice.name.toLowerCase().includes('hazel') ||
                    voice.name.toLowerCase().includes('samantha') ||
                    voice.name.toLowerCase().includes('karen') ||
                    voice.name.toLowerCase().includes('serena') ||
                    voice.gender === 'female'
                ) || voices[0];
            }
            
            console.log('Ananda AI Voice selected:', aiVoice?.name || 'Default');
        }
        
        function speakAIMessage(text, rate = 1.0, pitch = 1.0) {
            if (!soundEnabled || !voiceEnabled || !text) return;
            
            // Stop any current speech
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (aiVoice) {
                utterance.voice = aiVoice;
            }
            
            // Natural human-like settings
            utterance.rate = rate; // Normal speaking speed
            utterance.pitch = pitch; // Natural pitch, not artificially high
            utterance.volume = 0.9; // Clear volume
            
            // Add some personality to the AI voice
            utterance.onstart = () => {
                const aiCompanion = document.getElementById('aiCompanion');
                aiCompanion.style.animation = 'none';
                aiCompanion.style.animation = 'float 0.5s ease-in-out infinite alternate';
            };
            
            utterance.onend = () => {
                const aiCompanion = document.getElementById('aiCompanion');
                aiCompanion.style.animation = 'float 3s ease-in-out infinite';
            };
            
            speechSynthesis.speak(utterance);
        }
        
        function createTone(frequency, duration, type = 'sine') {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        function playMelody(notes, duration = 0.2) {
            notes.forEach((note, index) => {
                setTimeout(() => {
                    createTone(note, duration);
                }, index * duration * 1000);
            });
        }
        
        function playSound(type) {
            if (!soundEnabled) return;
            
            // Resume audio context if suspended (required by browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const aiCompanion = document.getElementById('aiCompanion');
            aiCompanion.style.transform = 'scale(1.2)';
            setTimeout(() => {
                aiCompanion.style.transform = 'scale(1)';
            }, 200);
            
            switch(type) {
                case 'start':
                    playMelody([523, 659, 784, 1047], 0.3); // C-E-G-C melody
                    break;
                case 'correct':
                    playMelody([659, 784, 1047], 0.15); // Success sound
                    break;
                case 'incorrect':
                    createTone(220, 0.5, 'sawtooth'); // Error buzz
                    break;
                case 'levelStart':
                    playMelody([392, 523, 659], 0.25); // Level start
                    break;
                case 'levelComplete':
                    playMelody([523, 659, 784, 1047, 1319], 0.2); // Victory fanfare
                    break;
                case 'victory':
                    playMelody([523, 659, 784, 1047, 1319, 1568, 2093], 0.3); // Final victory
                    break;
                case 'click':
                    createTone(800, 0.1); // Button click
                    break;
                case 'hover':
                    createTone(600, 0.05); // Hover sound
                    break;
            }
        }
        
        // Background Music System
        let currentMusicTheme = null;
        let musicIntervals = [];
        
        const musicThemes = {
            intro: {
                name: "Virus Hening Alert",
                frequencies: [110, 146, 185, 220], // Very dark, ominous tones
                pattern: [0, 3, 1, 2, 0, 3, 2, 1, 0], // Irregular, threatening pattern
                tempo: 1200, // Much faster for tension
                filter: 400, // Lower filter for darker sound
                volume: 0.06, // Louder for impact
                dissonance: true // Add dissonant harmonies
            },
            menu: {
                name: "Digital Horizon",
                frequencies: [261, 329, 392, 523], // C major - hopeful
                pattern: [0, 1, 2, 1, 0, 2, 3, 2], // Flowing pattern
                tempo: 3000,
                filter: 1000,
                volume: 0.04
            },
            level1: {
                name: "Island Waves",
                frequencies: [174, 220, 261, 329], // Calm, oceanic
                pattern: [0, 2, 1, 3, 2, 0], // Wave-like pattern
                tempo: 4000,
                filter: 800,
                volume: 0.035
            },
            level2: {
                name: "Urban Pulse",
                frequencies: [196, 247, 294, 370], // Mechanical, urban
                pattern: [0, 1, 0, 2, 1, 3, 2], // Rhythmic pattern
                tempo: 2500,
                filter: 700,
                volume: 0.04
            },
            level3: {
                name: "Tower Resonance",
                frequencies: [146, 185, 220, 277], // Deep, resonant
                pattern: [3, 2, 1, 0, 1, 2], // Ascending/descending
                tempo: 3500,
                filter: 900,
                volume: 0.038
            },
            level4: {
                name: "Fortress Defense",
                frequencies: [110, 138, 165, 207], // Dark, protective
                pattern: [0, 3, 1, 2, 3, 0, 2], // Defensive pattern
                tempo: 2200,
                filter: 500,
                volume: 0.042
            },
            level5: {
                name: "Hall of Applications",
                frequencies: [293, 369, 440, 554], // Bright, triumphant
                pattern: [0, 1, 2, 3, 2, 1, 0, 2], // Celebratory
                tempo: 2800,
                filter: 1200,
                volume: 0.045
            },
            victory: {
                name: "Digital Victory",
                frequencies: [523, 659, 784, 1047], // High, victorious
                pattern: [0, 1, 2, 3, 2, 1, 3, 0], // Victory fanfare
                tempo: 1800,
                filter: 1500,
                volume: 0.05
            }
        };
        
        function startBackgroundMusic(theme = 'menu') {
            stopBackgroundMusic();
            
            if (!soundEnabled) return;
            
            currentMusicTheme = theme;
            const musicData = musicThemes[theme];
            let patternIndex = 0;
            
            const playThemeNote = () => {
                if (audioContext.state === 'suspended' || !soundEnabled) return;
                
                const frequency = musicData.frequencies[musicData.pattern[patternIndex]];
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(musicData.filter, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(musicData.volume, audioContext.currentTime + 0.5);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 3);
                
                patternIndex = (patternIndex + 1) % musicData.pattern.length;
            };
            
            // Play first note immediately
            playThemeNote();
            
            // Set up interval for continuous music
            const musicInterval = setInterval(() => {
                if (currentMusicTheme === theme && soundEnabled) {
                    playThemeNote();
                } else {
                    clearInterval(musicInterval);
                }
            }, musicData.tempo);
            
            musicIntervals.push(musicInterval);
            
            // Add ambient harmony every few notes
            const harmonyInterval = setInterval(() => {
                if (currentMusicTheme === theme && soundEnabled && Math.random() > 0.6) {
                    const harmonyFreq = musicData.frequencies[Math.floor(Math.random() * musicData.frequencies.length)] * 0.5;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(harmonyFreq, audioContext.currentTime);
                    oscillator.type = 'triangle';
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(musicData.volume * 0.3, audioContext.currentTime + 1);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 4);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 4);
                }
            }, musicData.tempo * 2);
            
            // Add special tension effects for intro/warning theme
            if (theme === 'intro' && musicData.dissonance) {
                const tensionInterval = setInterval(() => {
                    if (currentMusicTheme === theme && soundEnabled && Math.random() > 0.5) {
                        // Create dissonant warning sound
                        const baseFreq = 120;
                        const dissonantFreq = baseFreq * 1.414; // Tritone interval (devil's interval)
                        
                        [baseFreq, dissonantFreq].forEach((freq, index) => {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            const filter = audioContext.createBiquadFilter();
                            
                            oscillator.connect(filter);
                            filter.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                            oscillator.type = 'sawtooth'; // Harsh sound for warning
                            
                            filter.type = 'lowpass';
                            filter.frequency.setValueAtTime(250 + Math.random() * 150, audioContext.currentTime);
                            filter.Q.setValueAtTime(5, audioContext.currentTime); // High resonance for piercing sound
                            
                            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.12, audioContext.currentTime + 0.05);
                            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.5);
                            
                            oscillator.start(audioContext.currentTime + index * 0.03);
                            oscillator.stop(audioContext.currentTime + 1.5);
                        });
                    }
                }, musicData.tempo * 0.8);
                
                musicIntervals.push(tensionInterval);
                
                // Add random glitch effects for virus theme
                const glitchInterval = setInterval(() => {
                    if (currentMusicTheme === theme && soundEnabled && Math.random() > 0.7) {
                        const glitchFreq = 60 + Math.random() * 120;
                        
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        const filter = audioContext.createBiquadFilter();
                        
                        oscillator.connect(filter);
                        filter.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(glitchFreq, audioContext.currentTime);
                        oscillator.type = 'square'; // Digital glitch sound
                        
                        filter.type = 'highpass';
                        filter.frequency.setValueAtTime(200, audioContext.currentTime);
                        
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.01);
                        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.08);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.08);
                    }
                }, 400); // More frequent glitches
                
                musicIntervals.push(glitchInterval);
                
                // Add deep bass rumble for ominous feeling
                const bassInterval = setInterval(() => {
                    if (currentMusicTheme === theme && soundEnabled && Math.random() > 0.8) {
                        const bassFreq = 40 + Math.random() * 30;
                        
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(bassFreq, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.08, audioContext.currentTime + 0.5);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 3);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 3);
                    }
                }, musicData.tempo * 2);
                
                musicIntervals.push(bassInterval);
            }
            
            musicIntervals.push(harmonyInterval);
        }
        
        function stopBackgroundMusic() {
            currentMusicTheme = null;
            musicIntervals.forEach(interval => clearInterval(interval));
            musicIntervals = [];
        }

        let soundEnabled = true;
        let voiceEnabled = true;
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundToggle = document.getElementById('soundToggle');
            soundToggle.textContent = soundEnabled ? '🔊': '🔇' ;

            if (!soundEnabled) {
                stopBackgroundMusic();
                speechSynthesis.cancel(); // Stop any current speech
            } else {
                // Resume appropriate music based on current screen
                const activeScreen = document.querySelector('.screen.active').id;
                if (activeScreen === 'setupScreen' || activeScreen === 'levelMapScreen') {
                    startBackgroundMusic('menu');
                } else if (activeScreen === 'introScreen') {
                    startBackgroundMusic('intro');
                } else if (activeScreen === 'gameScreen') {
                    startBackgroundMusic(`level${gameState.currentLevel}`);
                } else if (activeScreen === 'finalScreen') {
                    startBackgroundMusic('victory');
                }
            }
        }
        
        function toggleAIVoice() {
            voiceEnabled = !voiceEnabled;
            const voiceToggle = document.getElementById('voiceToggle');
            voiceToggle.textContent = voiceEnabled ? '🎤 ': '🔇' ;
            
            if (!voiceEnabled) {
                speechSynthesis.cancel(); // Stop any current speech
            }
        }
        
        function restartGame() {
            gameState = {
                playerName: '',
                playerClass: '',
                playerAvatar: '',
                difficulty: 'medium',
                currentLevel: 1,
                score: 0,
                completedLevels: [],
                currentQuestionIndex: 0
            };
            
            // Reset level access
            for (let i = 2; i <= 5; i++) {
                const levelCard = document.getElementById(`level${i}`);
                levelCard.classList.add('locked');
                levelCard.onclick = null;
            }
            
            stopBackgroundMusic();
            showScreen('setupScreen');
            document.getElementById('scoreDisplay').style.display = 'none';
        }

        // Birthday Celebration Functions
        function createBirthdayConfetti() {
            const colors = ['#ff00ff', '#00f5ff', '#ffff00', '#ff0080', '#00ff80', '#8000ff'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.innerHTML = ['🎊', '🎉', '✨', '🌟', '💫'][Math.floor(Math.random() * 5)];
                    confetti.style.cssText = `
                        position: fixed;
                        top: -50px;
                        left: ${Math.random() * 100}%;
                        font-size: ${Math.random() * 20 + 20}px;
                        z-index: 999;
                        pointer-events: none;
                        animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
                    `;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }, i * 100);
            }
            
            // Add CSS animation for confetti
            if (!document.getElementById('confettiStyle')) {
                const style = document.createElement('style');
                style.id = 'confettiStyle';
                style.textContent = `
                    @keyframes confettiFall {
                        to {
                            transform: translateY(100vh) rotate(720deg);
                            opacity: 0;
                        }
                    }
                    @keyframes pulse {
                        0%, 100% { transform: translate(-50%, -50%) scale(1); }
                        50% { transform: translate(-50%, -50%) scale(1.1); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function createFireworks() {
            const colors = ['#ff00ff', '#00f5ff', '#ffff00', '#ff0080', '#00ff80'];
            
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    firework.style.cssText = `
                        position: fixed;
                        top: ${Math.random() * 50 + 20}%;
                        left: ${Math.random() * 80 + 10}%;
                        width: 4px;
                        height: 4px;
                        background: ${color};
                        border-radius: 50%;
                        z-index: 998;
                        pointer-events: none;
                    `;
                    
                    document.body.appendChild(firework);
                    
                    // Create explosion effect
                    setTimeout(() => {
                        for (let j = 0; j < 8; j++) {
                            const spark = document.createElement('div');
                            const angle = (j * 45) * Math.PI / 180;
                            const distance = Math.random() * 100 + 50;
                            
                            spark.style.cssText = `
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 3px;
                                height: 3px;
                                background: ${color};
                                border-radius: 50%;
                                animation: sparkFly 1s ease-out forwards;
                                transform: translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px);
                            `;
                            
                            firework.appendChild(spark);
                        }
                        
                        setTimeout(() => {
                            firework.remove();
                        }, 1500);
                    }, 100);
                }, i * 300);
            }
            
            // Add spark animation
            if (!document.getElementById('fireworkStyle')) {
                const style = document.createElement('style');
                style.id = 'fireworkStyle';
                style.textContent = `
                    @keyframes sparkFly {
                        0% { opacity: 1; transform: scale(1); }
                        100% { opacity: 0; transform: scale(0.5); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function playVictoryMelody() {
            if (!soundEnabled) return;
            
            // Epic victory fanfare melody
            const victoryNotes = [
                523, 659, 784, 1047, // Rising triumph
                1047, 932, 784, 659, // Descending power
                523, 659, 784, 1047, 1319, // Building excitement  
                1047, 784, 659, 523, // Resolution
                392, 523, 659, 784, 1047, 1319, 1568, // Final crescendo
                2093, 1568, 1319, 1047, 784, 659, 523 // Grand finale
            ];
            
            victoryNotes.forEach((note, index) => {
                setTimeout(() => {
                    createTone(note, 0.35, 'sine');
                    // Add harmony for richer sound
                    if (index % 2 === 0) {
                        createTone(note * 0.75, 0.35, 'triangle');
                    }
                }, index * 250);
            });
            
            // Add fireworks during the melody
            setTimeout(() => {
                createFireworks();
            }, 1500);
            
            // Add triumphant chord at the end
            setTimeout(() => {
                [523, 659, 784, 1047].forEach(freq => {
                    createTone(freq, 1.5, 'sine');
                });
            }, victoryNotes.length * 250);
        }

        // Initialize the game when page loads
        window.onload = initGame;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972e926e134be9d9',t:'MTc1NTgyNTg4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
